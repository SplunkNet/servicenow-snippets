<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <!--<link rel="apple-touch-icon" href="icon.png">-->
        <!-- Place favicon.ico in the root directory -->

        <link rel="stylesheet" href="vendor/bootstrap.css">
        <link rel="stylesheet" href="vendor/prism.css">
        <link rel="stylesheet" href="styles/main.css">
    </head>
    <body>
        <!--[if lte IE 9]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
        <![endif]-->

        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <h1>ServiceNow Snippets</h1>
                    <p>by Mark Miller</p>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 fixed">
                    <p>Search:</p>
                    <input />
                </div>
                <div class="col-md-8 offset-md-4">

                    <ol>
                        <li>Service Portal Snippets</li>
                        <ol>
                            <li>Widget Snippets</li>
                            <li>CSS</li>
                            <li>Header Options</li>
                            <li>Misc</li>
                        </ol>
                        <li>Platform Snippets</li>
                        <ol>
                            <li>Server-Side</li>
                            <li>Client-Side</li>
                        </ol>
                    </ol>
                    
                    <hr/>

                    <div class="entries language-javascript">

                        <!-------------------- SERVER-SIDE -------------------->
                        <h2>Server-Side</h2>

                        <h3>Serivce Portal API ($sp)</h3>

                        <div class="entry">
                            <p>Get a Widget from the Portal Record</p>
                            <pre class="line-numbers"><code>data.typeahead = $sp.getWidgetFromInstance('typeahead-search');</code></pre>
                        </div>

                        <div class="entry">
                            <p>Get Service Portal URL Suffix</p>
                            <pre class="line-numbers"><code>var url_suffix = $sp.getPortalRecord().getValue('url_suffix');</code></pre>
                        </div>
                        
                        <div class="entry">
                            <p>Get Fields Object</p>
                            <pre class="line-numbers"><code>$sp.getFieldsObject();</code></pre>
                        </div>

<div class="entry">
<p>Get display field of a table</p>                    
<pre class="line-numbers"><code>var gr = new GlideRecord('incident');
gr.query();
gs.print(gr.getDisplayName()); /* number */</code></pre>
</div>

<div class="entry">
    <p>Does a variable exist?</p>
    <pre class="line-numbers"><code>if(typeof variableName != 'undefined') { }</code></pre>
</div>
                        
<div class="entry">
    <p>Verifying a record is found using `GlideRecord.get`</p>
    <pre class="line-numbers"><code>var gr = new GlideRecord(table);
    if(gr.get(sys_id)) {
        // it is found
        gs.print(gr.sys_created_on);
    } else {
        // it isn't found
        gs.print('record not found');
    }</code></pre>
</div>

<div class="entry">
    <p>Service Catalog - Excluding Class Names</p>
    <pre class="line-numbers"><code>sc.addQuery('sys_class_name', 'NOT IN', 'sc_cat_item_wizard,sc_cat_item_content');</code></pre>
</div>

<div class="entry">
    <p>Don't update system fields</p>
    <pre class="line-numbers"><code>gr.autoSysFields(false);</code></pre>
</div>

<div class="entry">
    <p>Don't run Business Rules</p>
    <pre class="line-numbers"><code>gr.setWorkflow(false);</code></pre>
</div>

<div class="entry">
    <p>Force update on record</p>
    <pre class="line-numbers"><code>gr.forceUpdate(true);</code></pre>
</div>
                        
                        
<div class="entry">
    <p>Bump a records' workflow - typically used if making changes to a record and isn't picked up by that records' workflow</p>
    <pre class="line-numbers"><code>var workflow = new Workflow();
        workflow.runFlows('record_sys_id', 'update');</code></pre>
</div>

                    
                        <hr/>

                        <h2>Client-Side</h2>

                        <h3>Client Controller</h3>

                        <p>Attempting to add GlideAjax to a widget Controller</p>
                        <pre class="line-numbers"><code>c.glideAjax = function() {
                                var ga = new GlideAjax('StoreUtilsAjax');
                                ga.addParam('sysparm_name', 'getItems');
                                ga.getXML(c.callback);
                            };
                            c.callback = function(response) {
                                var answer = response.responseXML.documentElement.getAttribute("answer");
                                console.log(">>>>>>: " + answer);
                            };
                            c.glideAjax();</code></pre>


                        <p>Different Angular Dependencies</p>
                        <pre class="line-numbers"><code>function ($rootScope, $scope, snRecordWatcher, spUtil, $location, $uibModal, cabrillo, $timeout, $window, $document) { /* code */ })</code></pre>


                        <p>Opening a Modal & Passing Scope to `$uibModal`</p>
                        <pre class="line-numbers"><code>$scope.openLogin = function () {
                                $scope.modalInstance = $uibModal.open({
                                    templateUrl: 'modalLogin',
                                    scope: $scope
                                });
                            };</code></pre>
                        

                        <p>Implementing an Angular Template</p>
                        <pre class="line-numbers"><code>function redirectUser(lastLoginDate){
                                if(lastLoginDate == '' || lastLoginDate == null || lastLoginDate == 'undefined'){
                                    $scope.modalInstance = $uibModal.open({
                                        templateUrl: 'welcomeTemplate',
                                        windowClass: 'welcome-pref-modal',
                                        scope: $scope
                                    });
                                }
                            }</code></pre>


                        <p>Using `$location` to Redirect User</p>
                        <pre class="line-numbers"><code>$scope.closeAndEdit = function() {
                                $scope.closeAndSave();
                                $location.url('?id=user_profile');
                            };</code></pre>
                    



                        




                        <h2>Background Scripts</h2>

                        <p>Force a record into an update set</p>
                        <pre class="line-numbers"><code>var rec = new GlideRecord('table_name_of_record');
                            rec.get('sys_id_of_record');
                            //Push the record into the current update set   
                            var um = new GlideUpdateManager2();
                            um.saveRecord(rec);</code></pre>
                        
                        


                        <p>Form field change in Client Script</p>
                        <pre class="line-numbers"><code>$scope.$on("field.change", function(evt, parms) {
                                //if (parms.field.name == c.data.user.name) {
                                if (parms.oldValue == c.data.user.sys_id) {
                                    //console.log("changing...");
                                    //c.data.setLocation = parms.newValue;
                                }
                                c.data.currentUser = parms.newValue;
                                c.server.update().then(function(response) {
                                    //spUtil.update($scope);
                                });
                            });</code></pre>



                        <p>Service Portal Angular Events</p>
                        <pre class="line-numbers"><code>$rootScope.$on('sp.form.record.updated', function() {
                                $scope.data.userForm.data.f._ui_actions[1].is_button = true;
                            });
                            
                            $rootScope.$on('data_table.click', function(event,obj) {
                                var link = {};
                                link.id = $scope.data.page;
                                link.table = obj.table;
                                link.sys_id = obj.sys_id;
                                $location.search(link);
                            });

                            $scope.$on("field.change", function(evt, parms) { }</code></pre>


                        <p>Display Choice Label instead of Choice Value</p>
                        <pre class="line-numbers"><code>var ritm = new GlideRecord("sc_req_item");
                            ritm.query();
                            while(ritm.next()){
                                ...
                                reqItem.stage = $sp.getFieldsObject(ritm, 'stage').stage.display_value;
                                ...
                            }</code></pre>


                        
                        <p>CatItem API</p>
                        <pre class="line-numbers"><code>var catalogItemJS = new sn_sc.CatItem(sc.getUniqueValue());
                                if (!catalogItemJS.canView())
                                    continue;
                                var catItemDetails = catalogItemJS.getItemSummary();</code></pre>

                        <p>CatCategory API</p>
                        <pre class="line-numbers"><code>categoryJS = new sn_sc.CatCategory(data.category_id);
                        if (!categoryJS.canView()) {
                        data.error = gs.getMessage("You do not have permission to see this category");
                        return;
                        }</code></pre>

                        <p>CatalogSearch API</p>
                        <pre class="line-numbers"><code>var items = data.items = [];
                                var catalog = $sp.getValue('sc_catalog');
                                var sc = new sn_sc.CatalogSearch().search(catalog, data.category_id, '', false, options.depth_search);
                                sc.addQuery('sys_class_name', 'NOT IN', 'sc_cat_item_wizard');
                                if (data.keywords)
                                    sc.addQuery('123TEXTQUERY321', data.keywords);
                                sc.orderBy('order');
                                sc.orderBy('name');
                                sc.query();
                        </code></pre>


                        <p>Recursive Function</p>
                        <pre class="line-numbers"><code>var results = [];
                                var nestedCategories = ['898fc5a0db00d74074c99447db9619d8'];
                                
                                getChildren(nestedCategories[0]);
                                searchItems();
                                $sp.logSearch('sc_cat_item', data.q, results.length);
                                return results;
                                
                                
                                function getChildren(sysID) {
                                    var gr = new GlideRecord('sc_category');
                                    gr.addQuery('parent', sysID);
                                    gr.addActiveQuery();
                                    gr.query();
                                    while(gr.next()) {
                                        var current = gr.sys_id.toString();
                                        nestedCategories.push(current);
                                        if(hasChildren(current)) {
                                            getChildren(current);
                                        }
                                    }
                                }
                            
                                function hasChildren(sysID) {
                                    var gr = new GlideRecord('sc_category');
                                    gr.addQuery('parent', sysID);
                                    gr.addActiveQuery();
                                    gr.query();
                                    if(gr.next()) {
                                        return true;
                                    } else {
                                        return false;
                                    }
                                }</code></pre>


                    </div>

                    
                </div>
            </div>
        </div>
        


        <script src="vendor/jquery-3.3.1.min.js"></script>
        <script src="vendor/bootstrap.js"></script>
        <script src="vendor/prism.js"></script>
        <script src="app/main.js"></script>

        <!-- Google Analytics: change UA-XXXXX-Y to be your site's ID. 
        <script>
            window.ga=function(){ga.q.push(arguments)};ga.q=[];ga.l=+new Date;
            ga('create','UA-XXXXX-Y','auto');ga('send','pageview')
        </script>
        <script src="https://www.google-analytics.com/analytics.js" async defer></script>
        -->
    </body>
</html>